# Паттерн Flyweight (Легковес)

## Описание
Легковес — это структурный паттерн проектирования, который позволяет использовать больше объектов в рамках выделенной оперативной памяти. Паттерн экономит память, разделяя общее состояние объектов между собой, вместо хранения одинаковых данных в каждом объекте.

## Проблема
Когда требуется создать большое количество похожих объектов, что может привести к чрезмерному использованию памяти.

## Решение
Паттерн Легковес предлагает выделить общее состояние (внутреннее) объектов в отдельные объекты, а в исходных объектах хранить только ссылки на эти общие части. Уникальное для каждого объекта состояние (внешнее) передаётся через параметры методов.

## Структура
- **Flyweight** — интерфейс, через который легковесы могут получать внешнее состояние и работать с ним
- **ConcreteFlyweight** — реализует интерфейс Flyweight и хранит внутреннее состояние
- **FlyweightFactory** — фабрика легковесов, создаёт и управляет объектами-легковесами
- **Client** — вычисляет или хранит внешнее состояние легковесов

## Пример на Python

```python
import json
from typing import Dict

# Легковес
class Flyweight:
    def __init__(self, shared_state):
        self._shared_state = shared_state
    
    def operation(self, unique_state):
        s = json.dumps(self._shared_state)
        u = json.dumps(unique_state)
        return f"Flyweight: Displaying shared ({s}) and unique ({u}) state."

# Фабрика легковесов
class FlyweightFactory:
    _flyweights: Dict[str, Flyweight] = {}
    
    def __init__(self, initial_flyweights):
        for state in initial_flyweights:
            self._flyweights[self.get_key(state)] = Flyweight(state)
    
    def get_key(self, state):
        # Этот метод возвращает строковый ключ на основе элементов состояния
        return "_".join(sorted(state))
    
    def get_flyweight(self, shared_state):
        key = self.get_key(shared_state)
        
        if not self._flyweights.get(key):
            print("FlyweightFactory: Can't find a flyweight, creating a new one.")
            self._flyweights[key] = Flyweight(shared_state)
        else:
            print("FlyweightFactory: Reusing existing flyweight.")
        
        return self._flyweights[key]
    
    def list_flyweights(self):
        count = len(self._flyweights)
        print(f"FlyweightFactory: I have {count} flyweights:")
        return "\n".join(map(str, self._flyweights.keys()))
```

## Применение
В реальных приложениях Легковес часто используется для:
- Оптимизации игровых объектов (деревья, частицы, элементы интерфейса)
- Кэширования и повторного использования данных
- Управления объектами документов (символы в текстовом редакторе)
- Пулы объектов (например, пулы соединений с базой данных)
- Кэширование запросов к базе данных

## Плюсы
1. Существенная экономия памяти, если в системе много похожих объектов
2. Позволяет загружать в память только необходимую информацию
3. Улучшает производительность приложения при работе с большим количеством объектов
4. Централизует управление состоянием через фабрику

## Минусы
1. Усложняет код из-за разделения состояния на внутреннее и внешнее
2. Может снизить производительность из-за дополнительных вычислений внешнего состояния
3. Добавляет сложность при отладке из-за общих ссылок на объекты
4. Требует неизменности внутреннего состояния, что может быть ограничением

## Когда использовать
- Когда приложение использует большое количество похожих объектов
- Когда объекты содержат дублирующуюся информацию, которую можно вынести в общее состояние
- Когда необходимо экономить память
- Когда требуется создать тысячи мелких объектов